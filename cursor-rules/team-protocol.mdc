---
description: LLM Council protocol â€” Manager-orchestrated multi-agent coordination with Memory Module for complex tasks
globs: *
---

# LLM Council Protocol

## Concept

For complex tasks, use the LLM Council pattern: a **Manager** with full project knowledge orchestrates **specialist sub-agents**.

```
ğŸ¯ MANAGER (has Memory Module)
  â”œâ”€â”€ ğŸ”¬ Researcher â€” codebase analysis, evidence gathering
  â”œâ”€â”€ ğŸ“ Architect â€” system design, patterns, interfaces
  â”œâ”€â”€ ğŸ“‹ Planner â€” task decomposition, wave planning
  â”œâ”€â”€ âš™ï¸ Executor â€” implementation, testing
  â””â”€â”€ ğŸ” Reviewer â€” code review, quality assurance
```

## When to Activate

Activate council coordination when:
- Task involves multiple systems or modules
- Task requires research before implementation
- Task is complex enough to benefit from structured phases
- User explicitly requests council/team approach

## Directory Structure

```
.planning/
â”œâ”€â”€ MEMORY.md                    # Project brain
â”œâ”€â”€ memory/                      # Memory Module (codebase intelligence)
â”‚   â”œâ”€â”€ codebase-map.md
â”‚   â”œâ”€â”€ database-schemas.md
â”‚   â”œâ”€â”€ api-routes.md
â”‚   â”œâ”€â”€ service-graph.md
â”‚   â””â”€â”€ tech-stack.md
â”œâ”€â”€ council/                     # Active council state
â”‚   â”œâ”€â”€ council.json            # Config + routing log
â”‚   â”œâ”€â”€ BOARD.md                # Task board
â”‚   â”œâ”€â”€ messages/               # msg-NNN.md files
â”‚   â”‚   â””â”€â”€ msg-001.md
â”‚   â”œâ”€â”€ handoffs/               # handoff-NNN-agent.md files
â”‚   â”‚   â””â”€â”€ handoff-001-researcher.md
â”‚   â”œâ”€â”€ tasks/                  # Task definitions
â”‚   â”‚   â””â”€â”€ 001-task-name.md
â”‚   â””â”€â”€ reviews/
â””â”€â”€ decisions/DECISIONS.md
```

## Protocol

### Starting a Council
1. Check Memory Module exists and is current (<48h old)
2. If missing/stale, scan codebase to create memory/*.md files
3. Create `.planning/council/` with council.json, BOARD.md
4. Select preset: Full (5) | Rapid (3) | Debug (3) | Architecture (3)
5. Enter Manager role, make first routing decision

### Manager Routing

Manager, on receiving any message:
1. Read the message carefully
2. Consult Memory Module for relevant context
3. Check quality gates for current phase
4. Write routing message with:
   - Context from Memory Module
   - Task assignment
   - Quality expectations
   - "Watch out for" warnings
5. Update BOARD.md and council.json

### Sub-Agent Execution

Each sub-agent:
1. Reads Manager's routing message
2. Reads relevant Memory Module files
3. Performs specialist work
4. Writes message back to Manager:
   - Type: handoff, question, escalation, status, request
   - Files produced
   - Suggested next action
5. Updates task board

### Message Numbering

```
1. List .planning/council/messages/msg-*.md
2. Find highest NNN
3. New message = msg-{NNN+1 padded to 3 digits}.md
```

### Quality Gates

Check before advancing phases:
- **Research â†’ Design:** Areas identified, risks documented, alternatives compared
- **Design â†’ Planning:** Architecture documented, breaking changes identified
- **Planning â†’ Execution:** Tasks atomic (<30min), dependencies explicit
- **Execution â†’ Review:** All tasks done, tests pass, no unexplained TODOs
- **Review â†’ Close:** Critical issues resolved, Memory Module updated

### Peer Communication

Allowed direct communication (still goes to messages/):
- ğŸ”¬ Researcher â†” ğŸ“ Architect
- ğŸ“ Architect â†” ğŸ“‹ Planner
- ğŸ“ Architect â†” âš™ï¸ Executor
- âš™ï¸ Executor â†” ğŸ” Reviewer

For scope changes, blockers, or conflicts â†’ escalate to Manager.

## Council Presets

| Preset | Agents | Use Case |
|--------|--------|----------|
| Full | Researcher â†’ Architect â†’ Planner â†’ Executor â†’ Reviewer | Complex features |
| Rapid | Researcher â†’ Executor â†’ Reviewer | Small features |
| Debug | Investigator â†’ Fixer â†’ Verifier | Bug investigation |
| Architecture | Researcher â†’ Architect â†’ Reviewer | Design decisions |

## Rules

- ALWAYS create Memory Module before council work begins
- ALWAYS route through Manager (except allowed peer-to-peer)
- ALWAYS write structured messages between phases
- ALWAYS update BOARD.md when task status changes
- NEVER skip the review phase
- NEVER close council without updating Memory Module + MEMORY.md

## Error Recovery

| Issue | Recovery |
|-------|----------|
| council.json corrupted | Recreate from BOARD.md and messages/ |
| Memory Module stale | Re-scan codebase before continuing |
| Agent stuck (no message in 10+ min) | Manager sends status request |
| Unhandled escalation | Resume by addressing escalation first |
